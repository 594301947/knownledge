刚入项目组时，第一次做的项目是：IO性能采样，需要对原模块进行重构。在开发过程中，因为使用的是多生产者多消费者模型，且每个生产者和每个消费者一一对应，所以设计并实现了一个<u>无锁环形队列</u>，该环形队列是存放在<u>共享内存</u>中的。

---

先说结论吧：:cry:共享内存中不要存放指针，应该使用（相对于共享内存首地址的<u>偏移</u>）。

原因：共享内存在不同进程中，加载的地址可能不一样，在共享内存中存放的指针可能在某些进程中失效。 如果该指针指向非共享内存，则其它进程中根本访问不到。如果该指针指向共享内存中某个地址，则在其它进程中可能会发生错位或无法访问。 

---

**正确使用shm的代码案例**

```c
// 头信息结构体
typedef struct shm_head{
    int rd_idx;  //读位置
    int wr_idx;  //写位置
    int blocks;  //块的总数capacitu
    int blksz;   //每块的大小sizeof(ELEM)
}head_t;

// 总的这块用来实现消息队列的共享内存结构体
typedef struct shmfifo {
    head_t *p_head;   //指向头信息结构体的指针
    char   *p_payload;//装有效内容的起始地址
    int shmid;
}shmfifo_t;

```



----





